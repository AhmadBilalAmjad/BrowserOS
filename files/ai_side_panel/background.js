/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";var t="get_page_content",e="close_panel",r="ping_content_script",n="heartbeat",o="heartbeat_ack",a="request_page_content",c="page_content_ready",i="refresh_tab_content",s="get_tabs",u="tabs_list",p="ping_content_script",l="pong_content_script",f="close_panel",h="error";const d={OPENAI_API_KEY:"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",DEV_MODE:!1};const g={debug:function(t,e,r){if(d.DEV_MODE){var n=(new Date).toISOString();"[".concat(n,"] [").concat(t,"] DEBUG: ").concat(e)}},info:function(t,e,r){if(d.DEV_MODE){var n=(new Date).toISOString();"[".concat(n,"] [").concat(t,"] INFO: ").concat(e)}},warn:function(t,e,r){var n=(new Date).toISOString();"[".concat(n,"] [").concat(t,"] WARN: ").concat(e)},error:function(t,e,r){var n=(new Date).toISOString();"[".concat(n,"] [").concat(t,"] ERROR: ").concat(e)}};function b(t){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},b(t)}function m(){m=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function p(t,e,r,n){var a=e&&e.prototype instanceof v?e:v,c=Object.create(a.prototype),i=new K(n||[]);return o(c,"_invoke",{value:R(t,r,i)}),c}function l(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=p;var f="suspendedStart",h="suspendedYield",d="executing",g="completed",y={};function v(){}function w(){}function O(){}var E={};u(E,c,(function(){return this}));var D=Object.getPrototypeOf,N=D&&D(D(k([])));N&&N!==r&&n.call(N,c)&&(E=N);var U=O.prototype=v.prototype=Object.create(E);function A(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function C(t,e){function r(o,a,c,i){var s=l(t[o],t,a);if("throw"!==s.type){var u=s.arg,p=u.value;return p&&"object"==b(p)&&n.call(p,"__await")?e.resolve(p.__await).then((function(t){r("next",t,c,i)}),(function(t){r("throw",t,c,i)})):e.resolve(p).then((function(t){u.value=t,c(u)}),(function(t){return r("throw",t,c,i)}))}i(s.arg)}var a;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return a=a?a.then(o,o):o()}})}function R(e,r,n){var o=f;return function(a,c){if(o===d)throw Error("Generator is already running");if(o===g){if("throw"===a)throw c;return{value:t,done:!0}}for(n.method=a,n.arg=c;;){var i=n.delegate;if(i){var s=x(i,n);if(s){if(s===y)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=g,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=d;var u=l(e,r,n);if("normal"===u.type){if(o=n.done?g:h,u.arg===y)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=g,n.method="throw",n.arg=u.arg)}}}function x(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,x(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var a=l(o,e.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,y;var c=a.arg;return c?c.done?(r[e.resultName]=c.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):c:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function G(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function B(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function K(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(G,this),this.reset(!0)}function k(e){if(e||""===e){var r=e[c];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,a=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return a.next=a}}throw new TypeError(b(e)+" is not iterable")}return w.prototype=O,o(U,"constructor",{value:O,configurable:!0}),o(O,"constructor",{value:w,configurable:!0}),w.displayName=u(O,s,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===w||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,O):(t.__proto__=O,u(t,s,"GeneratorFunction")),t.prototype=Object.create(U),t},e.awrap=function(t){return{__await:t}},A(C.prototype),u(C.prototype,i,(function(){return this})),e.AsyncIterator=C,e.async=function(t,r,n,o,a){void 0===a&&(a=Promise);var c=new C(p(t,r,n,o),a);return e.isGeneratorFunction(r)?c:c.next().then((function(t){return t.done?t.value:c.next()}))},A(U),u(U,s,"Generator"),u(U,c,(function(){return this})),u(U,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=k,K.prototype={constructor:K,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(B),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return i.type="throw",i.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var c=this.tryEntries[a],i=c.completion;if("root"===c.tryLoc)return o("end");if(c.tryLoc<=this.prev){var s=n.call(c,"catchLoc"),u=n.call(c,"finallyLoc");if(s&&u){if(this.prev<c.catchLoc)return o(c.catchLoc,!0);if(this.prev<c.finallyLoc)return o(c.finallyLoc)}else if(s){if(this.prev<c.catchLoc)return o(c.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return o(c.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var c=a?a.completion:{};return c.type=t,c.arg=e,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(c)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),B(r),y}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;B(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:k(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}function y(t,e,r,n,o,a,c){try{var i=t[a](c),s=i.value}catch(t){return void r(t)}i.done?e(s):Promise.resolve(s).then(n,o)}function v(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var a=t.apply(e,r);function c(t){y(a,n,o,c,i,"next",t)}function i(t){y(a,n,o,c,i,"throw",t)}c(void 0)}))}}var w=null,O=!1,E=new Map,D=null;function N(t){w!==t&&(g.info("BACKGROUND","Updating lastActiveTabId from ".concat(w," to ").concat(t)),w=t)}function U(){return A.apply(this,arguments)}function A(){return(A=v(m().mark((function e(){var r,n,o;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(D){e.next=3;break}return g.debug("BACKGROUND","Cannot prefetch - no port connection"),e.abrupt("return");case 3:return e.prev=3,e.next=6,new Promise((function(t){chrome.tabs.query({active:!0,currentWindow:!0},(function(e){if(chrome.runtime.lastError)return g.error("BACKGROUND","Error querying active tab:",chrome.runtime.lastError),void t([]);t(e)}))}));case 6:if((r=e.sent)&&0!==r.length){e.next=10;break}return g.debug("BACKGROUND","No active tab found for prefetching"),e.abrupt("return");case 10:if("number"==typeof(n=r[0]).id){e.next=14;break}return g.debug("BACKGROUND","Active tab has no ID, cannot prefetch"),e.abrupt("return");case 14:if(o=n.id,n.url&&n.url.startsWith("http")){e.next=18;break}return g.debug("BACKGROUND","Skipping prefetch for non-HTTP URL: ".concat(n.url)),e.abrupt("return");case 18:if(N(o),!E.has(o)){e.next=23;break}return g.debug("BACKGROUND","Content for tab ".concat(o," already in cache")),D&&D.postMessage({type:c,data:E.get(o)}),e.abrupt("return");case 23:return g.info("BACKGROUND","Prefetching content for active tab: ".concat(o)),e.next=26,x(o);case 26:chrome.tabs.sendMessage(o,{action:t},(function(t){chrome.runtime.lastError?g.error("BACKGROUND","Error prefetching page content:",chrome.runtime.lastError):t&&t.success&&(E.set(o,t.data),g.info("BACKGROUND","Successfully prefetched and cached content for tab: ".concat(o)),D&&D.postMessage({type:c,data:t.data}))})),e.next=32;break;case 29:e.prev=29,e.t0=e.catch(3),g.error("BACKGROUND","Error in prefetch function:",e.t0);case 32:case"end":return e.stop()}}),e,null,[[3,29]])})))).apply(this,arguments)}function C(t){return R.apply(this,arguments)}function R(){return(R=v(m().mark((function t(e){var r,n;return m().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,new Promise((function(t){chrome.tabs.get(e,(function(e){chrome.runtime.lastError?t(void 0):t(e.url)}))}));case 3:if((r=t.sent)&&r.startsWith("http")){t.next=6;break}return t.abrupt("return",!1);case 6:return t.next=8,chrome.scripting.executeScript({target:{tabId:e},func:function(){return Object.prototype.hasOwnProperty.call(window,"__AI_SIDE_PANEL_LOADED")}});case 8:return n=t.sent,t.abrupt("return",!!(n&&n[0]&&n[0].result));case 12:return t.prev=12,t.t0=t.catch(0),g.error("BACKGROUND","Failed to check script injection status:",t.t0),t.abrupt("return",!1);case 16:case"end":return t.stop()}}),t,null,[[0,12]])})))).apply(this,arguments)}function x(t){return G.apply(this,arguments)}function G(){return(G=v(m().mark((function t(e){var r;return m().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,new Promise((function(t){chrome.tabs.get(e,(function(e){chrome.runtime.lastError?t(void 0):t(e.url)}))}));case 3:if((r=t.sent)&&r.startsWith("http")){t.next=7;break}return g.debug("BACKGROUND","Skipping injection for non-http URL: ".concat(r)),t.abrupt("return");case 7:return t.next=9,C(e);case 9:if(!t.sent){t.next=13;break}return g.debug("BACKGROUND","Content script already injected, skipping..."),t.abrupt("return");case 13:return t.next=15,chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]});case 15:g.info("BACKGROUND","Content script successfully injected into tab",e),t.next=21;break;case 18:t.prev=18,t.t0=t.catch(0),g.error("BACKGROUND","Failed to inject content script:",t.t0);case 21:case"end":return t.stop()}}),t,null,[[0,18]])})))).apply(this,arguments)}chrome.runtime.onConnect.addListener((function(e){"side-panel-connection"===e.name&&(g.info("BACKGROUND","Side panel connected"),D=e,O=!0,U().catch((function(t){g.error("BACKGROUND","Error prefetching active tab content:",t)})),e.onMessage.addListener(function(){var d=v(m().mark((function d(b){var y,v;return m().wrap((function(d){for(;;)switch(d.prev=d.next){case 0:d.prev=0,d.t0=b.type,d.next=d.t0===n?4:d.t0===f?6:d.t0===a?9:d.t0===i?29:d.t0===s?39:d.t0===p?41:45;break;case 4:return e.postMessage({type:o}),d.abrupt("break",46);case 6:return g.info("BACKGROUND","Received close panel request from side panel"),O=!1,d.abrupt("break",46);case 9:if(b.tabId){d.next=11;break}return d.abrupt("return",e.postMessage({type:h,error:"No tab ID provided"}));case 11:if(N(b.tabId),g.info("BACKGROUND","Requesting page content for tab ".concat(b.tabId)),!E.has(b.tabId)){d.next=18;break}return g.info("BACKGROUND","Using cached content for tab: ".concat(b.tabId)),y=E.get(b.tabId),e.postMessage({type:c,data:y}),d.abrupt("return");case 18:return d.prev=18,d.next=21,x(b.tabId);case 21:chrome.tabs.sendMessage(b.tabId,{action:t},(function(t){if(chrome.runtime.lastError)return g.error("BACKGROUND","Error getting page content:",chrome.runtime.lastError),void e.postMessage({type:h,error:chrome.runtime.lastError.message||"Failed to get page content"});t&&t.success?(E.set(b.tabId,t.data),e.postMessage({type:c,data:t.data})):e.postMessage({type:h,error:(null==t?void 0:t.error)||"Failed to get page content"})})),d.next=28;break;case 24:d.prev=24,d.t1=d.catch(18),g.error("BACKGROUND","Error processing page content request:",d.t1),e.postMessage({type:h,error:d.t1 instanceof Error?d.t1.message:"Failed to get page content"});case 28:return d.abrupt("break",46);case 29:if(!b.tabId){d.next=37;break}return g.info("BACKGROUND","Refreshing content for tab ".concat(b.tabId)),E.delete(b.tabId),d.next=34,x(b.tabId);case 34:chrome.tabs.sendMessage(b.tabId,{action:t},(function(t){if(chrome.runtime.lastError)return g.error("BACKGROUND","Error refreshing page content:",chrome.runtime.lastError),void e.postMessage({type:h,error:chrome.runtime.lastError.message||"Failed to refresh page content"});t&&t.success?(E.set(b.tabId,t.data),e.postMessage({type:c,data:t.data})):e.postMessage({type:h,error:(null==t?void 0:t.error)||"Failed to refresh page content"})})),d.next=38;break;case 37:U().catch((function(t){g.error("BACKGROUND","Error refreshing active tab content:",t),e.postMessage({type:h,error:t instanceof Error?t.message:"Unknown error refreshing tab content"})}));case 38:return d.abrupt("break",46);case 39:try{chrome.tabs.query({currentWindow:!0},(function(t){if(chrome.runtime.lastError){var r=chrome.runtime.lastError.message||"Failed to get tabs";return g.error("BACKGROUND","Error getting tabs:",r),void e.postMessage({type:h,error:r})}var n=t.filter((function(t){return t.url&&t.url.startsWith("http")})).map((function(t){return{id:t.id,title:t.title||"",url:t.url||"",favIconUrl:t.favIconUrl||""}}));g.debug("BACKGROUND","Sending ".concat(n.length," tabs to sidepanel")),e.postMessage({type:u,data:n})}))}catch(t){v=t instanceof Error?t.message:"Unknown error fetching tabs",g.error("BACKGROUND","Error in get_tabs handler:",v),e.postMessage({type:h,error:v})}return d.abrupt("break",46);case 41:if(b.tabId){d.next=43;break}return d.abrupt("return",e.postMessage({type:h,error:"No tab ID provided"}));case 43:try{chrome.tabs.sendMessage(b.tabId,{action:r},(function(t){if(chrome.runtime.lastError)return g.error("BACKGROUND","Error pinging content script:",chrome.runtime.lastError),void e.postMessage({type:h,error:"Content script not available"});e.postMessage({type:l,data:t})}))}catch(t){g.error("BACKGROUND","Error in ping_content_script handler:",t),e.postMessage({type:h,error:"Content script not available"})}return d.abrupt("break",46);case 45:return d.abrupt("return",e.postMessage({type:h,error:"Unknown message type"}));case 46:d.next=52;break;case 48:d.prev=48,d.t2=d.catch(0),g.error("BACKGROUND","Error handling port message:",d.t2),e.postMessage({type:h,error:d.t2 instanceof Error?d.t2.message:"Unknown error"});case 52:case"end":return d.stop()}}),d,null,[[0,48],[18,24]])})));return function(t){return d.apply(this,arguments)}}()),e.onDisconnect.addListener((function(){g.info("BACKGROUND","Side panel disconnected"),D=null,O=!1})))})),chrome.commands.onCommand.addListener((function(t){"toggle-panel"===t&&(g.info("BACKGROUND","Toggle panel keyboard shortcut triggered"),g.info("BACKGROUND","Toggle visibility called"),g.info("BACKGROUND","Current panel state: ".concat(O?"open":"closed")),O?(g.info("BACKGROUND","Panel is open, attempting to close"),D?D.postMessage({type:f}):(chrome.runtime.sendMessage({action:e}).catch((function(t){g.info("BACKGROUND","Error sending close message: ".concat(t.message))})),O=!1)):(g.info("BACKGROUND","Panel is closed, attempting to open"),chrome.windows.getCurrent((function(t){var e=t.id;void 0!==e&&chrome.tabs.query({active:!0,currentWindow:!0},(function(t){if(t&&t.length>0&&void 0!==t[0].id)try{chrome.sidePanel.open({windowId:e,tabId:t[0].id}),O=!0,g.info("BACKGROUND","Side panel opened successfully")}catch(t){g.error("BACKGROUND","Error opening panel: ".concat(t.message))}else try{chrome.sidePanel.open({windowId:e}),O=!0,g.info("BACKGROUND","Side panel opened successfully with windowId only")}catch(t){g.error("BACKGROUND","Error opening panel: ".concat(t.message))}}))}))))})),chrome.action&&chrome.action.onClicked.addListener((function(t){t.id&&(w=t.id)}));try{chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})}catch(t){g.error("BACKGROUND","Error setting panel behavior:",t)}g.info("BACKGROUND","Background script initialized"),chrome.tabs&&chrome.tabs.onUpdated?chrome.tabs.onUpdated.addListener((function(t,e,r){var n;t&&"loading"===e.status&&e.url&&(g.info("BACKGROUND","Tab ".concat(t," navigating to new URL, clearing from cache")),E.delete(t)),t&&"complete"===e.status&&null!==(n=r.url)&&void 0!==n&&n.startsWith("http")&&(g.info("BACKGROUND","Tab ".concat(t," finished loading: ").concat(r.url)),x(t).catch((function(t){g.error("BACKGROUND","Error injecting content script:",t)})),r.active&&(w=t))})):g.error("BACKGROUND","chrome.tabs.onUpdated is not available"),chrome.tabs&&chrome.tabs.onActivated&&chrome.tabs.onActivated.addListener((function(t){t.tabId&&(g.info("BACKGROUND","Tab activated: ".concat(t.tabId)),w=t.tabId)})),chrome.tabs&&chrome.tabs.onRemoved&&chrome.tabs.onRemoved.addListener((function(t){g.info("BACKGROUND","Tab ".concat(t," closed, clearing from cache")),E.delete(t)}))})();